function getHistorialInicio(){var fecha=$("#fecha-inicio").val(),unidad_id=$("#unidad_id").val(),_token=$("input[name='_token']").val();fecha&&unidad_id&&$.ajax({url:HOST+"/api/historiales/getHistorialesFecha/"+unidad_id+"/"+fecha,type:"GET",cache:!1,beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(resp){console.log(resp),resp.respuesta.estado?(resp.historiales?($("#kilometraje").val(resp.historiales.kilometraje),$("#kilometraje").attr("readonly",!0),validarKilometraje()):($("#kilometraje").attr("readonly",!1),validarKilometraje()),resp.historial_anterior?($(".kilometraje_anterior").html("Kilometraje anterior:"+resp.historial_anterior.kilometraje),$("#input_km_anterior").val(resp.historial_anterior.kilometraje),$(".kilometraje_siguiente").html(""),$("#input_km_siguiente").val(""),resp.historial_siguiente&&($(".kilometraje_siguiente").html("Kilometraje siguiente:"+resp.historial_siguiente.kilometraje),$("#input_km_siguiente").val(resp.historial_siguiente.kilometraje)),validarKilometraje()):($(".kilometraje_anterior").html(""),$("#input_km_anterior").val(""),$(".kilometraje_siguiente").html(""),$("#input_km_siguiente").val(""),validarKilometraje())):($("#kilometraje").attr("readonly",!1),$(".kilometraje_anterior").html(""),$(".kilometraje_siguiente").html(""),$("#input_km_anterior").val(""),$("#input_km_siguiente").val(""),validarKilometraje())},error:function(jqXHR,textStatus,errorThrown){console.log(errorThrown)}})}function validarKilometraje(){var _token=$("input[name='_token']").val(),kilometraje=$("#kilometraje").val(),input_anterior=$("#input_km_anterior").val(),input_siguiente=$("#input_km_siguiente").val(),id=$("#unidad_id").val(),url=HOST+"/admin/calcular-promedio",estado=document.getElementById("historial-estado");kilometraje.length&&id.length?$.ajax({url:url,data:{id:id},type:"GET",dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(data){null==data.ultima||(""==kilometraje?(document.getElementById("historial-mark").style.display="none",document.getElementById("historial-danger").style.display="none",document.getElementById("historial-warning").style.display="none",document.getElementById("historial-check").style.display="none",estado.value="true",validarEstado()):parseInt(kilometraje)<parseInt(input_anterior)?(document.getElementById("historial-danger").style.display="initial",document.getElementById("historial-mark").style.display="none",document.getElementById("historial-warning").style.display="none",document.getElementById("historial-check").style.display="none",estado.value="false",validarEstado()):input_siguiente.length&&parseInt(kilometraje)>parseInt(input_siguiente)&&parseInt(input_siguiente)!=parseInt(input_anterior)?(document.getElementById("historial-danger").style.display="initial",document.getElementById("historial-mark").style.display="none",document.getElementById("historial-warning").style.display="none",document.getElementById("historial-check").style.display="none",estado.value="false",validarEstado()):parseInt(kilometraje)>data.porcentaje?(document.getElementById("historial-danger").style.display="none",document.getElementById("historial-check").style.display="none",document.getElementById("historial-warning").style.display="initial",document.getElementById("historial-mark").style.display="initial",estado.value="false",validarEstado(),document.getElementById("historial-mark").addEventListener("click",(function(){document.getElementById("historial-warning").style.display="none",document.getElementById("historial-mark").style.display="none",document.getElementById("historial-check").style.display="initial",estado.value="true",validarEstado()}))):(document.getElementById("historial-danger").style.display="none",document.getElementById("historial-warning").style.display="none",document.getElementById("historial-check").style.display="initial",document.getElementById("historial-mark").style.display="none",estado.value="true",validarEstado()))},error:function(jqXHR,textStatus,errorThrow){console.log(`${jqXHR}.${textStatus}: ${errorThrow}`)}}):0==kilometraje.length&&(document.getElementById("historial-mark").style.display="none",document.getElementById("historial-danger").style.display="none",document.getElementById("historial-warning").style.display="none",document.getElementById("historial-check").style.display="none",estado.value="true",validarEstado())}function validarEstado(){var submit=$("#submit");submit.attr("disabled",!1),$(".estados").each((function(){"false"==$(this).val()&&submit.attr("disabled","disabled")}))}var personal_especialidad;function formatearFecha(fecha){var today=new Date(fecha),dd=today.getDate(),mm=today.getMonth()+1,yyyy;return dd<10&&(dd="0"+dd),mm<10&&(mm="0"+mm),dd+"/"+mm+"/"+today.getFullYear()}function validarEstadoHistorial(){var submit=$("#submit");submit.attr("disabled",!1),$(".estados").each((function(){"false"==$(this).val()&&submit.attr("disabled","disabled")}))}$(".reabrir").on("click",(function(e){let id=$(this).data("id");var reabrir=this;$(`#reabrir-modal-${id}`).fireModal({title:"Reabrir Orden de Trabajo",body:$("#modal-reabrir-part").clone(),footerClass:"bg-whitesmoke",autofocus:!1,removeOnDismiss:!0,created:function(modal,e,form){modal.find("form")[0].action=reabrir.dataset.route},shown:function(modal,form){console.log("shown",modal,form)},buttons:[{text:"Continuar",submit:!0,class:"btn btn-primary btn-shadow",handler:function(modal){}}]})})),$(".anular").on("click",(function(e){let id=$(this).data("id");var anular=this;$(`#anular-modal-${id}`).fireModal({title:"Anular Orden de Trabajo",body:$("#modal-anular-part").clone(),footerClass:"bg-whitesmoke",autofocus:!1,removeOnDismiss:!0,created:function(modal,e,form){modal.find("form")[0].action=anular.dataset.route},shown:function(modal,form){console.log("shown",modal,form)},buttons:[{text:"Continuar",submit:!0,class:"btn btn-primary btn-shadow",handler:function(modal){}}]})})),$("#fecha-inicio").on("change",(function(e){getHistorialInicio()})),$("#unidad_id").on("change",(function(e){getHistorialInicio()})),$("#kilometraje").on("keyup",(function(e){validarKilometraje()})),$(".buscar_tareas").on("change",(function(e){var unidad_id=$("#unidad_id").val(),especialidad_ids=$("#especialidad_id").val(),_token=$("input[name='_token']").val();$.each(especialidad_ids,(function(i,item){"todas"===item&&(especialidad_ids=["todas"])})),unidad_id.length>0&&especialidad_ids.length>0&&($(".tareas").empty(),$.ajax({url:HOST+"/admin/show-mantenimiento-especialidad",data:{unidad_id:unidad_id,especialidad_ids:especialidad_ids},type:"GET",dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(data){console.log(data),data.length>0&&$.ajax({url:HOST+"/api/personal/filtrar_especialidad",data:{especialidad_ids:especialidad_ids},type:"GET",dataType:"json",cache:!1,beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(data_especialidad){$.each(data[0],(function(i,item){item.tareas.length&&$.each(item.tareas,(function(j,tarea){var tarea_id=tarea.id,tareas=tarea.descripcion;if(rows="<div>",rows+='<div class="form-group row mb-4">',rows+=`<label for="tareas[${tarea_id}][descripcion]" class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Tarea</label>`,rows+='<div class="col-sm-12 col-md-7">',rows+=`<input type="text" value="${tareas}" class="form-control" name="tareas[${tarea_id}][descripcion]" autocomplete="off" required readonly>`,rows+=`<input type="hidden" value="${tarea_id}" class="form-control" name="tareas[${tarea_id}][id]" required>`,rows+="</div>",rows+="</div>",rows+='<div class="form-group row mb-4">',rows+=`<label for="tareas[${tarea_id}][especialidad_id]" class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Especialidad</label>`,rows+='<div class="col-sm-12 col-md-7">',rows+=`<input type="text" value="${tarea.especialidad.nombre}" class="form-control" name="tareas[${tarea_id}][especialidad_id]" autocomplete="off" required readonly>`,rows+="</div>",rows+="</div>",null!=tarea.observaciones){var obs=tarea.observaciones;rows+='<div class="form-group row mb-4">',rows+=`<label for="tareas[${tarea_id}][observaciones]" class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Procedimiento</label>`,rows+='<div class="col-sm-12 col-md-7">',rows+=`<textarea class="form-control" name="tareas[${tarea_id}][observaciones]" style="height: 75px" readonly>${obs}</textarea>`,rows+="</div>",rows+="</div>"}rows+='<div class="form-group row mb-4">',rows+=`<label for="tareas[${tarea_id}][comentario]" class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Comentario</label>`,rows+='<div class="col-sm-12 col-md-7">',rows+=`<textarea class="form-control" name="tareas[${tarea_id}][comentario]" style="height: 75px"></textarea>`,rows+="</div>",rows+="</div>",rows+='<div class="form-group row mb-4">',rows+=`<label for="tareas[${tarea_id}][personal]" class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Personal</label>`,rows+='<div class="col-sm-12 col-md-7">',rows+=`<select class="form-control select2-personal" name="tareas[${tarea_id}][personal][]" multiple>"`,$.each(data_especialidad.respuesta.personal,(function(i,item){item.especialidad.nombre==tarea.especialidad.nombre&&(rows+='<option label="'+item.nombre+" - "+item.especialidad.nombre+'" value="'+item.id+'">'+item.nombre+" - "+item.especialidad.nombre+"</option>")})),rows+="</select>",rows+="</div>",rows+="</div>",rows+="</div>",rows+="<hr />",$(".tareas").append(rows),$(".select2-personal").select2({placeholder:"Selecciona al personal"})}))}))},error:function(jqXHR,textStatus,errorThrow){console.log(`${textStatus}: ${errorThrow}`)}})},error:function(jqXHR,textStatus,errorThrow){console.log(`${textStatus}: ${errorThrow}`)}}))})),$("#especialidad_id").on("change",(function(e){var especialidad_ids=$("#especialidad_id").val(),_token=$("input[name='_token']").val();$.each(especialidad_ids,(function(i,item){"todas"===item&&($("#especialidad_id").val("todas"),especialidad_ids=$("#especialidad_id").val())})),$.ajax({url:HOST+"/api/personal/filtrar_especialidad",data:{especialidad_ids:especialidad_ids},type:"GET",dataType:"json",cache:!1,beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(data){personal_especialidad=data,console.log("asigno: ",personal_especialidad);var seleccionados=$("#personal").find(":selected"),seleccionados=$.makeArray(seleccionados);$("#personal").empty().trigger("change"),$.each(data.respuesta.personal,(function(i,item){var newOption=new Option(item.nombre+" - "+item.especialidad.nombre,item.id,!1,!1);$("#personal").append(newOption).trigger("change"),$('#personal option[value="'+item.id+'"]').addClass(item.especialidad.nombre),$("#personal").trigger("change")}));var ids_seleccionados=[];$.each(seleccionados,(function(i,item){ids_seleccionados.push($(item).val())})),$("#personal").val(ids_seleccionados),$("#personal").trigger("change")},error:function(jqXHR,textStatus,errorThrow){console.log(`${textStatus}: ${errorThrow}`)}})})),$(".button-cerrar-historial").on("click",(function(e){let _this=this,cerrar=this,id=$(this).data("id"),orden_id=$(this).data("id"),route=$(this).data("route"),api=$(this).data("api");var _token=$('input[name="_token"]').val(),unidad_anterior=null,unidad_1=null,modal_listo=!1;let tipo_orden=$(this).data("tipo_orden");$(`#cerrar-historial-${id}`).fireModal({title:"Kilometraje de la Orden de Retiro",body:$("#cerrar-kilometraje-part").clone(),footerClass:"bg-whitesmoke",autofocus:!1,removeOnDismiss:!0,center:!0,created:function(modal,e,form){$.ajax({type:"GET",url:api,data:{},dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(respuesta){console.log(respuesta),unidad_1=respuesta[0],modal.find("input[name=id]").val(id).trigger("change"),modal.find("input[name=unidad_id]").val(unidad_1.unidad_id).trigger("change"),modal.find("input[name=kilometraje_1]").val(unidad_1.kilometraje).trigger("change"),modal.find("input[name=historial_1_id]").val(unidad_1.id).trigger("change"),fecha=formatearFecha(unidad_1.created_at),modal.find("label[id=kilometraje_1_label]").append(fecha+"<code>*</code>"),"Preventiva"==tipo_orden&&modal.find(".carga-preventivas").attr("hidden",!0),modal.find("form")[0].action=cerrar.dataset.route},fail:function(){iziToast.error({timeout:5e4,position:"topRight",title:"Error :",message:"Se produjo un error al obtener el historial de la unidad. Por favor, inténtelo nuevamente."})}})},onFormSubmit:function(modal,e,form){if(!modal_listo){e.preventDefault();let id=modal.find("input[name=unidad_id]").val();unidad_anterior=unidad_1,$.ajax({url:HOST+"/admin/calcular-promedio",data:{id:id},type:"GET",dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(data){if(null==data.ultima)modal.removeClass("modal-progress"),modal.modal("hide"),iziToast.error({title:"Error: ",message:"No se encontraron historiales para esta unidad.",position:"topRight",timeout:5e3});else{var input_kilometraje_1=modal.find("input[name=kilometraje_1]").val();if(input_kilometraje_1.length)if(kilometraje_1_estado_modal=modal.find("input[name=kilometraje_1_estado_modal]")[0],unidad_anterior){if(input_kilometraje_1==unidad_anterior.kilometraje)return modal_listo=!0,void modal.find("form").submit();if(parseInt(input_kilometraje_1)<unidad_anterior.kilometraje)modal.removeClass("modal-progress"),kilometraje_1_estado_modal.value="false",modal.find("a[id=historial-modal-danger-1]")[0].style.display="initial",modal.find("a[id=historial-modal-mark-1]")[0].style.display="none",modal.find("a[id=historial-modal-warning-1]")[0].style.display="none",modal.find("a[id=historial-modal-check-1]")[0].style.display="none";else if(parseInt(input_kilometraje_1)>data.porcentaje){var kilometraje_1_valor_comparar=modal.find("input[name=kilometraje_1_valor_comparar]").val();parseInt(input_kilometraje_1)!=parseInt(kilometraje_1_valor_comparar)&&(modal.removeClass("modal-progress"),kilometraje_1_estado_modal.value="false",modal.find("a[id=historial-modal-danger-1]")[0].style.display="none",modal.find("a[id=historial-modal-mark-1]")[0].style.display="initial",modal.find("a[id=historial-modal-warning-1]")[0].style.display="initial",modal.find("a[id=historial-modal-check-1]")[0].style.display="none",modal.find("a[id=historial-modal-mark-1]")[0].addEventListener("click",(function(){modal.find("input[name=kilometraje_1_valor_comparar]").val(parseInt(input_kilometraje_1)),modal.find("a[id=historial-modal-warning-1]")[0].style.display="none",modal.find("a[id=historial-modal-mark-1]")[0].style.display="none",modal.find("a[id=historial-modal-check-1]")[0].style.display="initial",kilometraje_1_estado_modal.value="true"})))}else modal.find("a[id=historial-modal-danger-1]")[0].style.display="none",modal.find("a[id=historial-modal-mark-1]")[0].style.display="none",modal.find("a[id=historial-modal-warning-1]")[0].style.display="none",modal.find("a[id=historial-modal-check-1]")[0].style.display="initial",kilometraje_1_estado_modal.value="true"}else modal.find("a[id=historial-modal-danger-1]")[0].style.display="none",modal.find("a[id=historial-modal-mark-1]")[0].style.display="none",modal.find("a[id=historial-modal-warning-1]")[0].style.display="none",modal.find("a[id=historial-modal-check-1]")[0].style.display="initial",kilometraje_1_estado_modal.value="true";else kilometraje_1_estado_modal=modal.find("input[name=kilometraje_1_estado_modal]")[0],kilometraje_1_estado_modal.value="true";"true"==kilometraje_1_estado_modal.value&&(historial_1=modal.find("input[name=historial_1_id]").val(),$.ajax({url:HOST+"/admin/calcular-promedio",data:{id:id},type:"GET",dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-CSRF-Token",_token)},success:function(data){$("#historial_tabla_promedio_"+id).html(data.promedio+" kms"),kms=$("#kilometraje-"+id).val();let estado_validar=document.getElementById(`historial-${orden_id}-estado`);null==data.ultima||(""==kms?(document.getElementById(`historial-mark-${orden_id}`).style.display="none",document.getElementById(`historial-danger-${orden_id}`).style.display="none",document.getElementById(`historial-warning-${orden_id}`).style.display="none",document.getElementById(`historial-check-${orden_id}`).style.display="none",estado_validar.value="false"):kms<data.ultima.kilometraje?(document.getElementById(`historial-danger-${orden_id}`).style.display="initial",document.getElementById(`historial-mark-${orden_id}`).style.display="none",document.getElementById(`historial-warning-${orden_id}`).style.display="none",document.getElementById(`historial-check-${orden_id}`).style.display="none",estado_validar.value="false",validarEstadoHistorial()):kms>data.porcentaje?(document.getElementById(`historial-danger-${orden_id}`).style.display="none",document.getElementById(`historial-check-${orden_id}`).style.display="none",document.getElementById(`historial-warning-${orden_id}`).style.display="initial",document.getElementById(`historial-mark-${orden_id}`).style.display="initial",estado_validar.value="false",validarEstadoHistorial(),document.getElementById(`historial-mark-${orden_id}`).addEventListener("click",(function(){document.getElementById(`historial-warning-${orden_id}`).style.display="none",document.getElementById(`historial-mark-${orden_id}`).style.display="none",document.getElementById(`historial-check-${orden_id}`).style.display="initial",estado_validar.value="true",validarEstadoHistorial()}))):(document.getElementById(`historial-danger-${orden_id}`).style.display="none",document.getElementById(`historial-warning-${orden_id}`).style.display="none",document.getElementById(`historial-check-${orden_id}`).style.display="initial",document.getElementById(`historial-mark-${orden_id}`).style.display="none",estado_validar.value="true",validarEstadoHistorial(),modal_listo=!0,modal.find("form").submit()))}}))}},error:function(jqXHR,textStatus,errorThrow){console.log(`${jqXHR}.${textStatus}: ${errorThrow}`)}})}},shown:function(modal,form){console.log("shown",modal,form)},buttons:[{text:"Cerrar la Orden de Trabajo",submit:!0,class:"btn btn-primary btn-shadow",handler:function(modal){}}]})})),$(".info-vales").on("click",(function(){iziToast.info({timeout:5e4,position:"topRight",title:"Info :",message:"La Orden de Trabajo ya cuenta con un Vale."})})),$("#replicar-fechas").on("click",(function(){""!=$(".fecha-realizacion-1").val()?$(".insertar-fecha").val($(".fecha-realizacion-1").val()):iziToast.info({timeout:5e4,position:"topRight",title:"Info :",message:"Primero debe seleccionar una fecha."})}));